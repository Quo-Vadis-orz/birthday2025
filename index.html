<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LoveFit Pro">
  <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/love-circled.png">
  <title>For My Queen</title>

  <!-- Three.js (CDN, GitHub Pages å¯ç”¨) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    :root {
      --primary: #ff7eb3;
      --primary-dark: #ff4d6d;
      --accent: #8e44ad;
      --bg-color: #fff0f3;
      --card-bg: rgba(255, 255, 255, 0.85);
      --text-main: #590d22;
      --text-sub: #a4133c;
      --shadow: 0 8px 20px rgba(255, 77, 109, 0.15);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

    body {
      margin: 0; padding: 0;
      font-family: -apple-system, "PingFang SC", sans-serif;
      background: linear-gradient(180deg, #fff0f3 0%, #ffd1dc 100%);
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--text-main);
      overflow: hidden;
    }

    #canvas-3d {
      position: absolute; top: 0; left: 0; width: 100%; height: 45vh;
      z-index: 0; pointer-events: none;
    }

    #touch-canvas {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 999;
    }

    .status-bar {
      padding: max(20px, env(safe-area-inset-top)) 20px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.3);
      backdrop-filter: blur(5px);
      z-index: 10;
      position: relative;
    }

    .user-info h1 { margin: 0; font-size: 20px; font-weight: 800; text-shadow: 0 0 10px rgba(255,255,255,0.8); }
    .user-info p { margin: 0; font-size: 12px; color: var(--text-sub); }

    .points-pill {
      background: rgba(255,255,255,0.9);
      padding: 5px 15px;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      font-weight: bold;
      color: var(--primary-dark);
      display: flex; align-items: center; gap: 5px;
    }

    .page-container {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 20px;
      padding-bottom: 110px;
      display: none; opacity: 0; transition: opacity 0.25s ease;
      z-index: 10;
      padding-top: 10px;
    }
    .page-container.active { display: block; opacity: 1; }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.5);
    }

    .chart-container {
      display: flex; justify-content: space-between; align-items: flex-end;
      height: 80px; padding-top: 10px; gap: 2px;
    }
    .chart-col { display: flex; flex-direction: column; align-items: center; flex: 1; gap: 6px; }
    .chart-bar {
      width: 10px; background: rgba(0,0,0,0.06); border-radius: 10px;
      position: relative; overflow: hidden; height: 100%;
    }
    .chart-fill {
      position: absolute; bottom: 0; left: 0; width: 100%;
      background: linear-gradient(to top, var(--primary), var(--primary-dark));
      border-radius: 10px;
      height: 5%;
      transition: height 0.8s cubic-bezier(.2,.9,.2,1);
    }
    .chart-label { font-size: 10px; color: #888; }

    .action-card { text-align: center; }
    .action-icon { font-size: 40px; margin-bottom: 5px; }
    .action-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
    .action-desc { font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4; }

    .btn-action {
      width: 100%; padding: 15px; border: none; border-radius: 16px;
      font-size: 16px; font-weight: bold; color: white; cursor: pointer;
      transition: transform 0.1s;
      position: relative; overflow: hidden;
    }
    .btn-action:active { transform: scale(0.96); }
    .btn-action::after {
      content: ""; position: absolute; top: 0; left: -120%; width: 120%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.45), transparent);
      transition: 0.55s;
    }
    .btn-action:active::after { left: 120%; transition: 0s; }

    .btn-sport { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
    .btn-sleep { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
    .disabled-btn { background: #e0e0e0 !important; color: #999 !important; box-shadow: none; pointer-events: none; }

    .wallet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    .coupon-card {
      background: #fff; border-radius: 16px; padding: 15px; text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative; border: 2px solid transparent;
    }
    .coupon-card.locked { filter: grayscale(1); opacity: 0.6; background: #eee; }
    .coupon-card.unlocked { border-color: var(--primary); }
    .coupon-card.used { opacity: 0.55; border: 2px dashed #ccc; }

    .c-tag {
      position: absolute; top: 0; left: 0; background: var(--primary); color: white;
      font-size: 10px; padding: 2px 8px; border-radius: 14px 0 10px 0;
    }

    .c-icon { font-size: 30px; margin-top: 8px; }
    .c-name { font-weight: 800; font-size: 13px; margin-top: 6px; color: #3a0a17; }
    .c-cost { font-size: 11px; color: #888; margin-top: 4px; }

    .loot-subtitle { font-size: 12px; color:#999; margin-top: -10px; margin-bottom: 10px; line-height: 1.4; }

    .loot-open-btn {
      margin-top: 8px;
      font-size: 12px;
      padding: 8px 10px;
      border: none;
      border-radius: 12px;
      width: 100%;
      font-weight: 900;
      color: #fff;
      background: linear-gradient(135deg, #ff7eb3 0%, #ff4d6d 100%);
      cursor: pointer;
    }
    .loot-open-btn:active { transform: scale(0.98); }

    .reward-pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(255,255,255,0.6);
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
      margin: 6px 6px 0 0;
      font-size: 12px;
      color: #5a0f24;
      max-width: 100%;
    }
    .reward-pill button {
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 900;
      color: #fff;
      background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
      cursor: pointer;
    }

    .couple-photo-box { width: 100%; margin: 20px 0; text-align: center; }
    .couple-img {
      width: 100%; max-width: 350px; height: auto;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(255, 126, 179, 0.3);
      border: 4px solid #fff;
      transition: transform 0.3s;
    }
    .couple-img:active { transform: scale(0.98); }
    .photo-caption { font-size: 12px; color: #ff9a9e; margin-top: 8px; font-weight: bold; letter-spacing: 1px; }

    .nav-bar {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
      background: rgba(255,255,255,0.92); backdrop-filter: blur(20px);
      display: flex; align-items: center; padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100;
    }
    .nav-item {
      flex: 1; height: 100%; display: flex; flex-direction: column;
      justify-content: center; align-items: center; color: #ccc; transition: all 0.25s;
    }
    .nav-item.active { color: var(--primary-dark); }
    .nav-item.active .nav-icon { transform: scale(1.12) translateY(-2px); }
    .nav-icon { font-size: 26px; margin-bottom: 2px; transition: transform 0.2s; }

    .modal-mask {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; z-index: 300;
      justify-content: center; align-items: center; backdrop-filter: blur(5px);
    }
    .modal-box {
      background: #fff; width: 84%; border-radius: 24px; padding: 26px 22px;
      text-align: center; animation: popUp 0.28s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes popUp { from { transform: scale(0.86); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 200; }
  </style>
</head>

<body>
  <div id="canvas-3d"></div>
  <canvas id="touch-canvas"></canvas>

  <div class="status-bar">
    <div class="user-info">
      <h1 id="greeting">æ—©å®‰, Så¥³ç‹</h1>
      <p id="level-title">LoveFit Pro â€¢ v2.1 (Blindbox Edition)</p>
    </div>
    <div class="points-pill">
      â¤ï¸ <span id="point-display">0</span>
    </div>
  </div>

  <!-- é¡µé¢1 -->
  <div id="page-home" class="page-container active">

    <div class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <span style="font-weight:900; font-size:14px; color:var(--text-main);">ğŸ“Š ä¸ƒæ—¥æ´»åŠ›è¶‹åŠ¿</span>
        <span style="font-size:11px; color:#999;">ä»Šæ—¥ = æ‰“å¡/ç¡è§‰ç´¯è®¡</span>
      </div>
      <div class="chart-container" id="week-chart"></div>
    </div>

    <div class="card action-card">
      <div class="action-icon">ğŸƒâ€â™€ï¸</div>
      <div class="action-title">æ´»åŠ›æ‰“å¡</div>
      <div class="action-desc">åŠ¨èµ·æ¥ï¼æ¯æ¬¡æ‰“å¡ +10 å¿ƒåŠ¨å€¼</div>
      <button class="btn-action btn-sport" id="btn-workout">
        ä»Šå¤©å·²æµæ±— (æ‰“å¡)
      </button>
    </div>

    <div class="card action-card">
      <div class="action-icon">ğŸŒ™</div>
      <div class="action-title">ç¾å®¹è§‰æŒ‘æˆ˜</div>
      <div class="action-desc">
        23:00 å‰ç¡è§‰ <span style="color:var(--accent); font-weight:900;">åŒå€å¥–åŠ±</span> (+20)<br>
        å¦åˆ™åªæœ‰è¾›è‹¦åˆ† (+5)
      </div>
      <button class="btn-action btn-sleep" id="btn-sleep">
        æˆ‘è¦å»ç¡å•¦ (æ™šå®‰)
      </button>
    </div>

    <div class="card" style="background: #fffbe6; border: 1px dashed #ffd591;">
      <div style="font-size: 12px; color: #d48806; margin-bottom: 5px;">ğŸ’Œ</div>
      <div id="daily-quote" style="font-size: 14px; color: #555; line-height: 1.55;">åŠ è½½ä¸­...</div>
    </div>

    <div class="couple-photo-box">
      <img src="us1.jpg" class="couple-img" alt="æˆ‘ä»¬" id="photo1">
      <div class="photo-caption">â¤ï¸ é™ªä¼´æ˜¯æœ€é•¿æƒ…çš„å‘Šç™½ â¤ï¸</div>
    </div>
  </div>

  <!-- é¡µé¢2 -->
  <div id="page-wallet" class="page-container">
    <h2 style="font-size: 18px; margin-bottom: 15px;">æˆ‘çš„æˆå°±å¢™ ğŸ†</h2>
    <div class="wallet-grid" id="badge-list"></div>

    <h2 style="font-size: 18px; margin: 25px 0 10px;">ç›²ç›’ç ”ç©¶æ‰€ ğŸ</h2>
    <div class="loot-subtitle">
      ç”¨å¿ƒåŠ¨å€¼å¼€ç›’ï¼æŠ½åˆ°çš„å¥–åŠ±ä¼šè¿›ã€Œå¥³ç‹èƒŒåŒ…ã€ï¼Œéšæ—¶å¯æ ¸é”€ã€‚<br>
      <span style="color:#ff4d6d; font-weight:900;">è¶Šè´µçš„ç›’å­è¶Šå®¹æ˜“å‡ºç¨€æœ‰</span> âœ¨
    </div>
    <div class="wallet-grid" id="lootbox-list"></div>

    <h2 style="font-size: 18px; margin: 25px 0 10px;">å¥³ç‹èƒŒåŒ… ğŸ‘œ</h2>
    <div class="card" style="padding: 14px 14px 18px;">
      <div style="font-size:12px;color:#999; margin-bottom:8px;">æŠ½åˆ°çš„å¥–åŠ±ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œç‚¹å‡»â€œä½¿ç”¨â€å³å¯æ ¸é”€ã€‚</div>
      <div id="reward-bag"></div>
    </div>

    <div class="couple-photo-box">
      <img src="us2.jpg" class="couple-img" alt="æˆ‘ä»¬" id="photo2">
      <div class="photo-caption">âœ¨ ä¸ºäº†é‡è§æ›´å¥½çš„æˆ‘ä»¬åŠªåŠ›ï¼ âœ¨</div>
    </div>

    <div style="height: 30px;"></div>
  </div>

  <div class="nav-bar">
    <div class="nav-item active" id="tab-home">
      <div class="nav-icon">ğŸ”¥</div>
      <div>å…»æˆ</div>
    </div>
    <div class="nav-item" id="tab-wallet">
      <div class="nav-icon">ğŸ</div>
      <div>ç›²ç›’</div>
    </div>
  </div>

  <div class="modal-mask" id="modal">
    <div class="modal-box">
      <div style="font-size: 52px; margin-bottom: 10px;" id="m-icon">ğŸ‰</div>
      <h3 id="m-title" style="font-size: 20px; margin: 0 0 10px; color:#333;">æ ‡é¢˜</h3>
      <p id="m-desc" style="font-size: 14px; color: #666; line-height: 1.55; white-space: pre-line;">å†…å®¹</p>
      <button id="m-btn" style="margin-top: 18px; background: var(--primary-dark); color: #fff; border: none; padding: 10px 30px; border-radius: 20px; font-size: 14px; font-weight:900;">
        æ”¶ä¸‹å•¦
      </button>
    </div>
  </div>

  <canvas id="confetti-canvas"></canvas>

  <script>
    // ================== å·¥å…·ï¼šå®‰å…¨æ—¥æœŸï¼ˆiOS å¯é ï¼‰ ==================
    function dateKey(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    function weekdayCNFromISO(iso) {
      const [y, m, d] = iso.split('-').map(Number);
      const dt = new Date(y, m - 1, d);
      const arr = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      return arr[dt.getDay()];
    }

    // ================== é…ç½® ==================
    const CONFIG = {
      gfName: "Så¥³ç‹",

      badges: [
        { points: 50, icon: "ğŸ‘¶", name: "èŒæ–°èµ·æ­¥", desc: "ç´¯è®¡è·å¾— 50 å¿ƒåŠ¨å€¼" },
        { points: 200, icon: "ğŸ”¥", name: "ç‡ƒçƒ§å§è„‚è‚ª", desc: "ç´¯è®¡è·å¾— 200 å¿ƒåŠ¨å€¼" },
        { points: 500, icon: "ğŸ§šâ€â™€ï¸", name: "è‡ªå¾‹ä»™å¥³", desc: "ç´¯è®¡è·å¾— 500 å¿ƒåŠ¨å€¼" },
        { points: 1000, icon: "ğŸ‘‘", name: "å¥³ç‹é©¾åˆ°", desc: "ç´¯è®¡è·å¾— 1000 å¿ƒåŠ¨å€¼" }
      ],

      // ç›²ç›’ï¼šæ‰è½è¡¨ï¼ˆæƒé‡è¶Šå¤§è¶Šå¸¸è§ï¼‰
      lootboxes: [
        {
          id: "lb_basic",
          icon: "ğŸ€",
          name: "åŸºç¡€ç›²ç›’",
          cost: 120,
          desc: "å…¥é—¨å¼€ç®±ï¼Œå¿«ä¹å°±å¥½",
          drops: [
            { w: 45, rarity: "N",  icon: "ğŸµ", title: "å¥¶èŒ¶å¬å”¤åˆ¸",  detail: "æ— æ¡ä»¶è¯·å–ä¸€æ¯å¥¶èŒ¶" },
            { w: 30, rarity: "N",  icon: "ğŸ“", title: "æ°´æœæŠ•å–‚åˆ¸",  detail: "éšæœºæ°´æœä¸€ä»½" },
            { w: 18, rarity: "R",  icon: "ğŸ’†â€â™€ï¸", title: "è‚©é¢ˆæŒ‰æ‘©åˆ¸",  detail: "30åˆ†é’ŸæŒ‰æ‘©æœåŠ¡" },
            { w: 6,  rarity: "SR", icon: "ğŸ£", title: "å¤§é¤è¯·å®¢åˆ¸",  detail: "å»åƒä½ æƒ³åƒçš„é‚£å®¶åº—" },
            { w: 1,  rarity: "SSR",icon: "ğŸ’„", title: "å°ç¤¼ç‰©å…‘æ¢åˆ¸", detail: "500å…ƒå†…ç¤¼ç‰©ä¸€ä»¶" }
          ]
        },
        {
          id: "lb_premium",
          icon: "âœ¨",
          name: "é«˜çº§ç›²ç›’",
          cost: 360,
          desc: "æé«˜ç¨€æœ‰æ¦‚ç‡ï¼",
          drops: [
            { w: 28, rarity: "N",  icon: "ğŸµ", title: "å¥¶èŒ¶å¬å”¤åˆ¸",  detail: "æ— æ¡ä»¶è¯·å–ä¸€æ¯å¥¶èŒ¶" },
            { w: 26, rarity: "R",  icon: "ğŸ’†â€â™€ï¸", title: "è‚©é¢ˆæŒ‰æ‘©åˆ¸",  detail: "30åˆ†é’ŸæŒ‰æ‘©æœåŠ¡" },
            { w: 22, rarity: "R",  icon: "ğŸ¬", title: "ç”µå½±çº¦ä¼šåˆ¸",  detail: "é€‰ä½ æƒ³çœ‹çš„ç”µå½±" },
            { w: 16, rarity: "SR", icon: "ğŸ£", title: "å¤§é¤è¯·å®¢åˆ¸",  detail: "å»åƒä½ æƒ³åƒçš„é‚£å®¶åº—" },
            { w: 7,  rarity: "SR", icon: "ğŸ›ï¸", title: "é€›è¡—é™ªä¼´åˆ¸",  detail: "å…¨ç¨‹æåŒ…ä¸å–Šç´¯" },
            { w: 1,  rarity: "SSR",icon: "âœˆï¸", title: "åŒäººå‘¨è¾¹æ¸¸",  detail: "è½¦é…’è¡Œç¨‹æˆ‘æ¥å®‰æ’" }
          ]
        },
        {
          id: "lb_queen",
          icon: "ğŸ‘‘",
          name: "å¥³ç‹ç›²ç›’",
          cost: 880,
          desc: "æ‡‚çš„äººéƒ½æ‡‚ï¼ˆæœ€å®¹æ˜“å‡º SSRï¼‰",
          drops: [
            { w: 16, rarity: "R",  icon: "ğŸ’†â€â™€ï¸", title: "è‚©é¢ˆæŒ‰æ‘©åˆ¸",  detail: "30åˆ†é’ŸæŒ‰æ‘©æœåŠ¡" },
            { w: 18, rarity: "SR", icon: "ğŸ£", title: "å¤§é¤è¯·å®¢åˆ¸",  detail: "å»åƒä½ æƒ³åƒçš„é‚£å®¶åº—" },
            { w: 18, rarity: "SR", icon: "ğŸ¬", title: "ç”µå½±çº¦ä¼šåˆ¸",  detail: "é€‰ä½ æƒ³çœ‹çš„ç”µå½±" },
            { w: 16, rarity: "SR", icon: "ğŸ›ï¸", title: "é€›è¡—é™ªä¼´åˆ¸",  detail: "å…¨ç¨‹æåŒ…ä¸å–Šç´¯" },
            { w: 26, rarity: "SSR",icon: "âœˆï¸", title: "åŒäººå‘¨è¾¹æ¸¸",  detail: "è½¦é…’è¡Œç¨‹æˆ‘æ¥å®‰æ’" },
            { w: 6,  rarity: "SSR",icon: "ğŸ’„", title: "å°ç¤¼ç‰©å…‘æ¢åˆ¸", detail: "500å…ƒå†…ç¤¼ç‰©ä¸€ä»¶" }
          ]
        }
      ]
    };

    const quotes = [
      "å¦‚æœä½ è§‰å¾—ç´¯ï¼Œå°±æƒ³æƒ³æˆ‘ä¹Ÿåœ¨é™ªä½ å˜å¥½ã€‚",
      "ä»Šå¤©çš„åŠªåŠ›ï¼Œæ˜¯ä¸ºäº†æ˜å¤©ç©¿ä¸Šæ›´ç¾çš„è£™å­ï¼",
      "æ—©ç¡æ—©èµ·ï¼Œçš®è‚¤å¥½å¥½ï¼Œå¿ƒæƒ…å¥½å¥½ã€‚",
      "ä½ æµæ±—çš„æ ·å­ï¼ŒçœŸçš„å¾ˆè¿·äººã€‚",
      "åˆ«æ”¾å¼ƒï¼Œå¥–åŠ±å°±åœ¨å‰é¢ç­‰ç€ä½ å‘¢ï¼"
    ];

    // ================== çŠ¶æ€ ==================
    let state = {
      points: 0,
      lastWorkout: null, // ISO
      lastSleep: null,   // ISO
      history: [],       // 7å¤© {date:'YYYY-MM-DD', val:number}
      rewards: [],       // æŠ½åˆ°çš„å¥–åŠ± [{id, rarity, icon, title, detail, used:false, ts}]
    };

    const LS_KEY = "love_habit_data_v21";

    function loadData() {
      const saved = localStorage.getItem(LS_KEY);
      if (saved) {
        try { state = Object.assign(state, JSON.parse(saved)); } catch(e) {}
      }
      if (!Array.isArray(state.history)) state.history = [];
      if (!Array.isArray(state.rewards)) state.rewards = [];
    }
    function saveData() {
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    // ================== 3D å¿ƒè„ ==================
    function init3DHeart() {
      const container = document.getElementById('canvas-3d');
      container.innerHTML = "";

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / (window.innerHeight * 0.45),
        0.1,
        1000
      );
      camera.position.z = 25;

      const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight * 0.45);
      container.appendChild(renderer.domElement);

      const geometry = new THREE.BufferGeometry();
      const vertices = [];
      const particleCount = 1500;

      for (let i = 0; i < particleCount; i++) {
        const t = Math.random() * Math.PI * 2;
        let x = 16 * Math.pow(Math.sin(t), 3);
        let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
        let z = (Math.random() - 0.5) * 10;

        x += (Math.random() - 0.5) * 1.5;
        y += (Math.random() - 0.5) * 1.5;

        vertices.push(x * 0.5, y * 0.5 + 2, z * 0.5);
      }

      geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

      const material = new THREE.PointsMaterial({
        color: 0xff4d6d,
        size: 0.6,
        transparent: true,
        opacity: 0.85
      });

      const heart = new THREE.Points(geometry, material);
      scene.add(heart);

      let time = 0;
      function animate() {
        requestAnimationFrame(animate);
        time += 0.015;
        heart.rotation.y += 0.005;
        const scale = 1 + Math.sin(time * 3) * 0.05;
        heart.scale.set(scale, scale, scale);
        renderer.render(scene, camera);
      }
      animate();

      // resize
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / (window.innerHeight * 0.45);
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight * 0.45);
      }, { passive: true });
    }

    // ================== æŒ‡å°–ç²’å­ï¼ˆä¿®å¤ï¼šå¤šæ¬¡è§¦æ‘¸ç¨³å®šè§¦å‘ï¼‰ ==================
    function initTouchParticles() {
      const canvas = document.getElementById('touch-canvas');
      const ctx = canvas.getContext('2d', { alpha: true });

      function resize() {
        canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
        canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
        canvas.style.width = window.innerWidth + "px";
        canvas.style.height = window.innerHeight + "px";
        ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
      }
      resize();
      window.addEventListener('resize', resize, { passive: true });

      let particles = [];
      let lastEmit = 0;

      function emit(x, y, count = 8) {
        const now = performance.now();
        if (now - lastEmit < 10) return; // èŠ‚æµï¼šæå‡æ‰‹æœºæ€§èƒ½
        lastEmit = now;

        for (let i = 0; i < count; i++) {
          particles.push({
            x, y,
            vx: (Math.random() - 0.5) * 3.8,
            vy: (Math.random() - 0.5) * 3.8,
            life: 1,
            r: 2 + Math.random() * 3,
            hue: 330 + Math.random() * 30
          });
        }
        if (particles.length > 520) particles = particles.slice(-520);
      }

      // Pointerï¼ˆå…¼å®¹é¼ æ ‡+è§¦å±ï¼‰
      window.addEventListener('pointerdown', (e) => {
        emit(e.clientX, e.clientY, 16);
      }, { passive: true });

      window.addEventListener('pointermove', (e) => {
        emit(e.clientX, e.clientY, 6);
      }, { passive: true });

      // iOS Safariï¼štouch äº‹ä»¶æ›´ç¨³ï¼ˆå¹¶ä¸”è¦ passive:false æ‰èƒ½ preventDefaultï¼‰
      window.addEventListener('touchstart', (e) => {
        const t = e.touches[0];
        if (!t) return;
        emit(t.clientX, t.clientY, 18);
      }, { passive: true });

      window.addEventListener('touchmove', (e) => {
        const t = e.touches[0];
        if (!t) return;
        emit(t.clientX, t.clientY, 10);
      }, { passive: false });

      function loop() {
        ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

        // åå‘å¾ªç¯æ›´æ–°ï¼šé¿å… splice å½±å“éå†
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.05;        // å¾®é‡åŠ›
          p.life -= 0.018;

          ctx.globalAlpha = Math.max(p.life, 0);
          ctx.fillStyle = `hsla(${p.hue}, 100%, 70%, 1)`;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r * p.life, 0, Math.PI * 2);
          ctx.fill();

          if (p.life <= 0) particles.splice(i, 1);
        }

        ctx.globalAlpha = 1;
        requestAnimationFrame(loop);
      }
      loop();
    }

    // ================== å›¾è¡¨ï¼ˆä¿®å¤ï¼šiOS æ—¥æœŸè§£æé—®é¢˜ + æ‰“å¡ç«‹å³åˆ·æ–°ï¼‰ ==================
    function ensure7DaysHistory() {
      const today = dateKey();
      // åˆå§‹åŒ–ï¼šè¡¥é½æœ€è¿‘7å¤©
      if (state.history.length === 0) {
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          state.history.push({ date: dateKey(d), val: 0 });
        }
        saveData();
      }

      // å¦‚æœæœ€åä¸€å¤©ä¸æ˜¯ä»Šå¤©ï¼šæ»šåŠ¨è¡¥é½
      const last = state.history[state.history.length - 1]?.date;
      if (last !== today) {
        // å¯èƒ½éš”äº†å‡ å¤©ï¼šé€å¤©è¡¥
        const lastDate = last ? new Date(last + "T00:00:00") : new Date();
        const nowDate = new Date(today + "T00:00:00");
        let cur = new Date(lastDate);
        while (dateKey(cur) !== today) {
          cur.setDate(cur.getDate() + 1);
          state.history.push({ date: dateKey(cur), val: 0 });
        }
        while (state.history.length > 7) state.history.shift();
        saveData();
      }
    }

    function renderChart() {
      const container = document.getElementById('week-chart');
      container.innerHTML = '';

      const maxVal = Math.max(...state.history.map(h => h.val), 30);

      // å…ˆæ’å…¥ DOMï¼ˆheight å…ˆ 5%ï¼‰ï¼Œå†ä¸‹ä¸€å¸§è®¾å®šç›®æ ‡é«˜åº¦ï¼Œç¡®ä¿åŠ¨ç”»èƒ½è·‘
      const fills = [];
      state.history.forEach(day => {
        const col = document.createElement('div');
        col.className = 'chart-col';

        const bar = document.createElement('div');
        bar.className = 'chart-bar';

        const fill = document.createElement('div');
        fill.className = 'chart-fill';
        bar.appendChild(fill);

        const label = document.createElement('div');
        label.className = 'chart-label';
        label.textContent = weekdayCNFromISO(day.date);

        col.appendChild(bar);
        col.appendChild(label);

        container.appendChild(col);
        fills.push({ el: fill, val: day.val });
      });

      requestAnimationFrame(() => {
        fills.forEach(o => {
          const h = (o.val / maxVal) * 100;
          o.el.style.height = `${Math.max(h, 5)}%`;
        });
      });
    }

    function addToTodayChart(val) {
      ensure7DaysHistory();
      state.history[state.history.length - 1].val += val;
      saveData();
      renderChart();
    }

    // ================== UI & ä¸šåŠ¡ ==================
    function setGreeting() {
      const h = new Date().getHours();
      let t = "æ—©å®‰";
      if (h >= 11 && h < 13) t = "åˆå®‰";
      else if (h >= 13 && h < 18) t = "ä¸‹åˆå¥½";
      else if (h >= 18) t = "æ™šä¸Šå¥½";
      document.getElementById('greeting').innerText = `${t}, ${CONFIG.gfName}`;
    }

    function animatePoints(start, end) {
      let current = start;
      const step = Math.max(1, Math.ceil((end - start) / 12));
      const timer = setInterval(() => {
        current += step;
        if (current >= end) { current = end; clearInterval(timer); }
        document.getElementById('point-display').innerText = current;
      }, 24);
    }

    function addPoints(num) {
      const start = state.points;
      const end = state.points + num;
      state.points = end;
      saveData();
      animatePoints(start, end);
      refreshUI(); // ç«‹å³åˆ·æ–°æŒ‰é’®/èƒŒåŒ…ç­‰
    }

    function checkDailyStatus() {
      const today = dateKey();
      const btnWork = document.getElementById('btn-workout');
      const btnSleep = document.getElementById('btn-sleep');

      btnWork.classList.remove('disabled-btn');
      btnSleep.classList.remove('disabled-btn');

      btnWork.innerText = "ä»Šå¤©å·²æµæ±— (æ‰“å¡)";
      btnSleep.innerText = "æˆ‘è¦å»ç¡å•¦ (æ™šå®‰)";

      btnWork.onclick = handleWorkout;
      btnSleep.onclick = handleSleep;

      if (state.lastWorkout === today) {
        btnWork.innerText = "âœ… ä»Šæ—¥å·²æ‰“å¡";
        btnWork.classList.add('disabled-btn');
        btnWork.onclick = null;
      }
      if (state.lastSleep === today) {
        btnSleep.innerText = "ğŸ˜´ å·²è®°å½•ç¡çœ ";
        btnSleep.classList.add('disabled-btn');
        btnSleep.onclick = null;
      }
    }

    function handleWorkout() {
      const today = dateKey();
      addPoints(10);
      state.lastWorkout = today;
      saveData();

      addToTodayChart(10);
      checkDailyStatus();
      showModal("ğŸ‰ æ´»åŠ›æ»¡æ»¡ï¼", "æ‰“å¡æˆåŠŸï¼å¿ƒåŠ¨å€¼ +10", "ğŸƒâ€â™€ï¸");
      fireConfetti();
    }

    function handleSleep() {
      const today = dateKey();
      const h = new Date().getHours();

      let pts = 5;
      let msg = "æ™šå®‰ï¼(å¿ƒåŠ¨å€¼ +5)";
      let title = "æ™šå®‰ç›å¡å·´å¡";

      if (h >= 20 && h <= 23) {
        pts = 20; title = "âœ¨ å®Œç¾ç¾å®¹è§‰ï¼";
        msg = "å¤ªæ£’äº†ï¼23:00 å‰ç¡è§‰\nå¥–åŠ±ç¿»å€ +20";
      } else if (h >= 0 && h < 4) {
        msg = "å°ç¬¨è›‹å¿«å»ç¡ï¼(ç†¬å¤œå®‰æ…°åˆ† +5)";
      }

      addPoints(pts);
      state.lastSleep = today;
      saveData();

      addToTodayChart(pts);
      checkDailyStatus();

      showModal(title, msg, "ğŸŒ™");
      if (pts === 20) fireConfetti();
    }

    // ================== ç›²ç›’ç³»ç»Ÿï¼ˆæ›¿æ¢å…‘æ¢ç³»ç»Ÿï¼‰ ==================
    function rarityText(r) {
      return r === "SSR" ? "SSR â€¢ æç¨€æœ‰" : r === "SR" ? "SR â€¢ ç¨€æœ‰" : r === "R" ? "R â€¢ ç½•è§" : "N â€¢ æ™®é€š";
    }

    function weightedPick(items) {
      const total = items.reduce((s, it) => s + it.w, 0);
      let r = Math.random() * total;
      for (const it of items) {
        r -= it.w;
        if (r <= 0) return it;
      }
      return items[items.length - 1];
    }

    function openLootbox(boxId) {
      const box = CONFIG.lootboxes.find(b => b.id === boxId);
      if (!box) return;

      if (state.points < box.cost) {
        showModal("ä¸å¤Ÿå¿ƒåŠ¨å€¼ ğŸ˜¤", `éœ€è¦ ${box.cost} åˆ†æ‰èƒ½æ‰“å¼€ã€${box.name}ã€‘`, "ğŸ’”");
        return;
      }

      // å…ˆæ‰£åˆ†
      const start = state.points;
      state.points -= box.cost;
      saveData();
      animatePoints(start, state.points);
      refreshUI();

      // å¼€ç›’åŠ¨ç”»ï¼ˆçº¯å‰ç«¯ï¼šå…ˆå¼¹â€œå¼€ç›’ä¸­â€ï¼Œå†æ˜¾ç¤ºç»“æœï¼‰
      showModal("å¼€ç›’ä¸­â€¦", "å¥³ç‹è¯·ç¨å€™ï¼Œæ­£åœ¨æ‰«æå®‡å®™å¥½è¿â€¦", "ğŸ”®", true);

      setTimeout(() => {
        const drop = weightedPick(box.drops);
        const reward = {
          id: "rw_" + Math.random().toString(16).slice(2) + "_" + Date.now(),
          rarity: drop.rarity,
          icon: drop.icon,
          title: drop.title,
          detail: drop.detail,
          used: false,
          ts: Date.now()
        };
        state.rewards.unshift(reward);
        saveData();
        refreshUI();

        const big = drop.rarity === "SSR" || drop.rarity === "SR";
        const title = big ? "ğŸ‡ æ¬§çš‡é™ä¸´ï¼" : "ğŸ æŠ½åˆ°å•¦ï¼";
        const desc = `ä½ è·å¾—ï¼š${drop.icon}ã€${drop.title}ã€‘\n${rarityText(drop.rarity)}\n\nå·²æ”¾å…¥ã€Œå¥³ç‹èƒŒåŒ…ã€`;
        showModal(title, desc, drop.icon);
        fireConfetti();
      }, 700);
    }

    function useReward(rewardId) {
      const r = state.rewards.find(x => x.id === rewardId);
      if (!r || r.used) return;

      if (confirm(`æ ¸é”€ä½¿ç”¨ã€${r.title}ã€‘ï¼Ÿ\nï¼ˆä½¿ç”¨åä¼šæ ‡è®°å·²ä½¿ç”¨ï¼‰`)) {
        r.used = true;
        saveData();
        refreshUI();
        showModal("âœ… å·²æ ¸é”€", `ä½ ä½¿ç”¨äº†ï¼š${r.icon}ã€${r.title}ã€‘\n\nå¿«å»ä½¿å”¤ç”·æœ‹å‹å§ï¼`, r.icon);
        fireConfetti();
      }
    }

    // ================== åˆ·æ–° UIï¼ˆæˆå°±+ç›²ç›’+èƒŒåŒ…ï¼‰ ==================
    function refreshUI() {
      document.getElementById('point-display').innerText = state.points;

      // æˆå°±å¢™
      const bList = document.getElementById('badge-list');
      bList.innerHTML = '';
      CONFIG.badges.forEach(b => {
        const unlocked = state.points >= b.points;
        const div = document.createElement('div');
        div.className = `coupon-card ${unlocked ? 'unlocked' : 'locked'}`;
        div.innerHTML = `
          <div class="c-tag" style="background:${unlocked ? '#ffcc00' : '#ccc'}">æˆå°±</div>
          <div class="c-icon">${b.icon}</div>
          <div class="c-name">${b.name}</div>
          <div class="c-cost">éœ€ ${b.points}</div>
        `;
        if (unlocked) {
          div.onclick = () => showModal(b.name, b.desc, b.icon);
        }
        bList.appendChild(div);
      });

      // ç›²ç›’åˆ—è¡¨
      const lbList = document.getElementById('lootbox-list');
      lbList.innerHTML = '';
      CONFIG.lootboxes.forEach(lb => {
        const afford = state.points >= lb.cost;
        const div = document.createElement('div');
        div.className = `coupon-card ${afford ? 'unlocked' : 'locked'}`;
        div.innerHTML = `
          <div class="c-tag">ç›²ç›’</div>
          <div class="c-icon">${lb.icon}</div>
          <div class="c-name">${lb.name}</div>
          <div class="c-cost">${lb.cost} åˆ† â€¢ ${lb.desc}</div>
          <button class="loot-open-btn" ${afford ? "" : "disabled"}>${afford ? "æ‰“å¼€ç›²ç›’" : "å¿ƒåŠ¨å€¼ä¸è¶³"}</button>
        `;
        div.querySelector('button').onclick = (e) => {
          e.stopPropagation();
          openLootbox(lb.id);
        };
        div.onclick = () => {
          // å±•ç¤ºæ‰è½ä¿¡æ¯ï¼ˆä¸å‰§é€å…·ä½“æ¦‚ç‡å¤ªç»†ä¹Ÿè¡Œï¼Œè¿™é‡Œç»™ä¸ªâ€œç¨€æœ‰åº¦æç¤ºâ€ï¼‰
          const rar = lb.drops.map(d => d.rarity).filter((v,i,a) => a.indexOf(v)===i).join(" / ");
          showModal(lb.name, `èŠ±è´¹ï¼š${lb.cost} åˆ†\nå¯èƒ½ç¨€æœ‰åº¦ï¼š${rar}\n\nï¼ˆæç¤ºï¼šè¶Šè´µè¶Šå®¹æ˜“å‡ºç¨€æœ‰ï¼‰`, lb.icon);
        };
        lbList.appendChild(div);
      });

      // èƒŒåŒ…
      const bag = document.getElementById('reward-bag');
      bag.innerHTML = '';
      if (state.rewards.length === 0) {
        bag.innerHTML = `<div style="font-size:12px;color:#999;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿï½å»å¼€ä¸ªç›²ç›’å§ ğŸ</div>`;
      } else {
        state.rewards.slice(0, 30).forEach(r => {
          const pill = document.createElement('div');
          pill.className = 'reward-pill';
          pill.innerHTML = `
            <span style="font-size:14px;">${r.icon}</span>
            <span style="font-weight:900;">${r.title}</span>
            <span style="color:#999;">(${rarityText(r.rarity)})</span>
            ${r.used ? `<span style="margin-left:auto; color:#999; font-weight:900;">å·²ä½¿ç”¨</span>`
                     : `<span style="margin-left:auto;"></span><button>ä½¿ç”¨</button>`}
          `;
          const btn = pill.querySelector('button');
          if (btn) btn.onclick = () => useReward(r.id);
          bag.appendChild(pill);
        });
      }

      checkDailyStatus();
    }

    // ================== åˆ‡æ¢ Tab ==================
    function switchTab(t) {
      document.querySelectorAll('.page-container').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
      document.getElementById(`page-${t}`).classList.add('active');
      document.getElementById(`tab-${t}`).classList.add('active');
    }

    // ================== å¼¹çª— ==================
    const modal = document.getElementById('modal');
    function showModal(t, d, i, lockBtn = false) {
      document.getElementById('m-title').innerText = t;
      document.getElementById('m-desc').innerText = d;
      document.getElementById('m-icon').innerText = i;
      const btn = document.getElementById('m-btn');
      btn.innerText = lockBtn ? "è¯·ç¨å€™â€¦" : "æ”¶ä¸‹å•¦";
      btn.disabled = lockBtn;
      btn.style.opacity = lockBtn ? "0.7" : "1";
      modal.style.display = 'flex';
    }
    function closeModal() { modal.style.display = 'none'; }
    document.getElementById('m-btn').onclick = closeModal;

    // ================== æ’’èŠ± ==================
    function fireConfetti() {
      const cvs = document.getElementById('confetti-canvas');
      const ctx = cvs.getContext('2d');
      cvs.width = window.innerWidth; cvs.height = window.innerHeight;

      const p = [];
      const cols = ['#ff4d6d', '#ff9a9e', '#a18cd1', '#ffd1dc', '#ffcc00'];
      for (let i = 0; i < 90; i++) {
        p.push({
          x: cvs.width / 2,
          y: cvs.height * 0.35,
          vx: (Math.random() - 0.5) * 18,
          vy: (Math.random() - 0.8) * 18,
          s: Math.random() * 7 + 2,
          c: cols[Math.floor(Math.random() * cols.length)],
          l: 110
        });
      }

      function draw() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        for (let i = p.length - 1; i >= 0; i--) {
          const pi = p[i];
          pi.x += pi.vx;
          pi.y += pi.vy;
          pi.vy += 0.45;
          pi.l--;

          ctx.fillStyle = pi.c;
          ctx.beginPath();
          ctx.arc(pi.x, pi.y, pi.s, 0, Math.PI * 2);
          ctx.fill();

          if (pi.l <= 0) p.splice(i, 1);
        }
        if (p.length > 0) requestAnimationFrame(draw);
      }
      draw();
    }

    // ================== å¯åŠ¨ ==================
    window.onload = () => {
      loadData();

      // ç»‘å®šæŒ‰é’®/ç‚¹å‡»
      document.getElementById('btn-workout').onclick = handleWorkout;
      document.getElementById('btn-sleep').onclick = handleSleep;

      document.getElementById('tab-home').onclick = () => switchTab('home');
      document.getElementById('tab-wallet').onclick = () => switchTab('wallet');

      document.getElementById('photo1').onclick = () => showModal('çˆ±ä½ å“Ÿ', 'é™ªä¼´æ˜¯æœ€é•¿æƒ…çš„å‘Šç™½', 'ğŸ¥°');
      document.getElementById('photo2').onclick = () => showModal('åŠ æ²¹', 'ä¸ºäº†åŒäººæ¸¸å†²å†²å†²ï¼', 'âœˆï¸');

      // ä¸šåŠ¡åˆå§‹åŒ–
      ensure7DaysHistory();
      renderChart();
      refreshUI();
      setGreeting();
      document.getElementById('daily-quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];

      // ç‰¹æ•ˆå¯åŠ¨
      init3DHeart();
      initTouchParticles();
    };
  </script>
</body>
</html>
